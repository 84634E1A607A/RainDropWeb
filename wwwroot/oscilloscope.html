<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>RainDrop Command Center</title>
    <script type="text/javascript" src="js/jquery-3.6.4.min.js"></script>
    <script type="text/javascript" src="js/engineeringValue.js"></script>
    <link rel="stylesheet" href="css/mdui.min.css"/>
</head>
<body class="mdui-loaded mdui-appbar-with-toolbar mdui-drawer-body-left mdui-theme-primary-purple mdui-theme-accent-light-blue mdui-theme-layout-auto">

<header class="mdui-appbar mdui-appbar-fixed">
    <div class="mdui-toolbar mdui-color-theme">
        <span class="mdui-btn mdui-btn-icon mdui-ripple" mdui-drawer="{target: '#main-drawer', swipe: true}">
            <i class="mdui-icon material-icons">menu</i>
        </span>
        <a href="/Index" class="mdui-typo-headline">RainDrop Command Center</a>
    </div>
</header>

<div class="mdui-drawer" id="main-drawer">
    <div class="mdui-list">
        <a href="/Index" class="mdui-list-item mdui-ripple">Home</a>
        <a href="/Oscilloscope" class="mdui-list-item mdui-ripple">Oscilloscope</a>
        <a href="power-source.html" class="mdui-list-item mdui-ripple">Power Source</a>
        <a href="wave-generator.html" class="mdui-list-item mdui-ripple">Wave Gen</a>
    </div>
</div>

<div class="mdui-container mdui-row" style="padding-top: 60px">
    <div class="mdui-col-xs-12">
        <div class="mdui-card">
            <div class="mdui-card-content">
                <div id="oscilloscope-div" style="right: 100%">
                    <canvas id="oscilloscope-main"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="mdui-col-xs-12" style="margin-top: 20px">
        <div class="mdui-row">
            <div class="mdui-col-xs-6 mdui-col-md-3">
                <button class="mdui-btn mdui-color-theme mdui-ripple" id="start-button">开始</button>
                <script type="text/javascript">
                    $("#start-button").click(function () {
                        const oscilloscope = document.oscilloscope;
                        if (!document.oscilloscope.started) {
                            oscilloscope.sync();

                            // To finish sync
                            setTimeout(() => {
                                oscilloscope.start();
                            }, 50);
                        } else {
                            oscilloscope.stop();
                        }
                    });
                </script>
            </div>
        </div>
    </div>

    <div class="mdui-col-xs-12" style="margin-top: 60px">
        <h1 class="mdui-typo-title">设备属性</h1>
        <div class="mdui-row">

            <div class="mdui-col-xs-6 mdui-col-md-3 mdui-textfield">
                <label for="time-per-grid" class="mdui-textfield-label">单格时间 (s)</label>
                <input class="mdui-textfield-input" type="text" value="1m" id="time-per-grid">
                <script type="text/javascript">
                    $("#time-per-grid").change(function () {
                        const time = $(this).val().trim();
                        const oscilloscope = document.oscilloscope;

                        if (time === "") {
                            $(this).val(EngineeringValue.To(oscilloscope.timePerGrid));
                            return;
                        }

                        const timePerGrid = EngineeringValue.From(time.replace(/s$/i, ""));

                        if (!isNaN(timePerGrid)) {
                            $(this).val(EngineeringValue.To(timePerGrid));
                            oscilloscope.timePerGrid = timePerGrid;
                            oscilloscope.redraw();
                        } else {
                            mdui.snackbar({
                                message: `Invalid timebase: ${time}`,
                                position: "right-top"
                            })
                        }
                    })
                </script>
            </div>

            <div class="mdui-col-xs-6 mdui-col-md-3 mdui-textfield">
                <label for="sampling-frequency" class="mdui-textfield-label">采样频率 (Hz)</label>
                <input class="mdui-textfield-input" type="text" value="1M" id="sampling-frequency">
                <script type="text/javascript">
                    $("#sampling-frequency").change(function () {
                        const frequency = $(this).val().trim();
                        const oscilloscope = document.oscilloscope;

                        if (frequency === "") {
                            $(this).val(EngineeringValue.To(oscilloscope.frequency));
                            return;
                        }

                        const samplingFrequency = EngineeringValue.From(frequency.replace(/Hz$/i, ""));

                        if (isNaN(samplingFrequency))
                            mdui.snackbar({
                                message: `Invalid sampling frequency: ${frequency}`,
                                position: "right-top"
                            });
                        else if (samplingFrequency > 1e3 && samplingFrequency < 40e6) {
                            $(this).val(EngineeringValue.To(samplingFrequency));
                            oscilloscope.frequency = samplingFrequency;
                            oscilloscope.sync();
                        } else if (samplingFrequency < 1e3)
                            mdui.snackbar({
                                message: `${samplingFrequency}Hz is too low and will make the oscilloscope unresponsive.`,
                                position: "right-top"
                            });
                        else if (samplingFrequency > 40e6)
                            mdui.snackbar({
                                message: `${samplingFrequency / 1e6}MHz is too high and oscilloscope doesn't support it.`,
                                position: "right-top"
                            });
                    });
                </script>
            </div>

            <div class="mdui-col-xs-6 mdui-col-md-3 mdui-textfield">
                <label for="samples" class="mdui-textfield-label">采样数</label>
                <select class="mdui-select" id="samples" style="width: 100%"> </select>
                <script type="text/javascript">
                    const samples = $("#samples");
                    [32, 64, 128, 256, 512, 1024, 2048].forEach((v) => samples.append(
                        `<option value="${v}">${v}</option>`
                    ));

                    samples.children().last().attr("selected", "selected");

                    samples.change(function () {
                        const oscilloscope = document.oscilloscope;
                        oscilloscope.samples = parseInt($(this).val());
                        oscilloscope.sync();
                    })
                </script>
            </div>

            <div class="mdui-col-xs-6 mdui-col-md-3 mdui-textfield">
                <label for="average" class="mdui-textfield-label">平均</label>
                <select class="mdui-select" id="average" style="width: 100%"> </select>
                <script type="text/javascript">
                    const average = $("#average");
                    [1, 2, 4, 8, 16].forEach((v) => average.append(
                        `<option value="${v}">${v}</option>`
                    ));

                    average.change(function () {
                        const oscilloscope = document.oscilloscope;
                        oscilloscope.average = parseInt($(this).val());
                    })
                </script>
            </div>

        </div>
    </div>

    <div id="channel-properties">
        <script type="text/javascript">
            [1, 2].forEach((c) => {
                $("#channel-properties").append(`
            <div class="mdui-col-xs-12 mdui-col-md-6" style="margin-top: 60px">
                <h1 class="mdui-typo-title">通道${c}属性</h1>
                <div class="mdui-row">

                    <div class="mdui-col-xs-6">
                        <div class="mdui-textfield">
                            <label for="channel${c}-voltage" class="mdui-textfield-label">单格电压 (V)</label>
                            <input class="mdui-textfield-input" type="text" value="2" id="channel${c}-voltage">
                        </div>
                    </div>

                    <div class="mdui-col-xs-6">
                        <div class="mdui-textfield">
                            <label for="channel${c}-offset" class="mdui-textfield-label">直流偏置 (V)</label>
                            <input class="mdui-textfield-input" type="text" value="0" id="channel${c}-offset">
                        </div>
                    </div>
                </div>
            </div>
                    `);

                $(`#channel${c}-voltage`).change(function () {
                    const voltage = $(this).val().trim();
                    const oscilloscope = document.oscilloscope;

                    if (voltage === "") {
                        $(this).val(EngineeringValue.To(oscilloscope.amplitudePerGrid[c - 1]));
                        return;
                    }

                    const voltagePerGrid = EngineeringValue.From(voltage.replace(/v$/i, ""));

                    if (isNaN(voltagePerGrid))
                        mdui.snackbar({
                            message: `Invalid voltage: ${voltage}`,
                            position: "right-top"
                        });
                    else if (voltagePerGrid < 1e-3)
                        mdui.snackbar({
                            message: `${voltagePerGrid / 1000}V is too low to be accurately displayed.`,
                            position: "right-top"
                        });
                    else {
                        $(this).value(EngineeringValue.To(voltagePerGrid));
                        oscilloscope.amplitudePerGrid[c - 1] = voltagePerGrid;
                        oscilloscope.sync();
                    }
                })

                $(`#channel${c}-offset`).change(function () {
                    const offset = $(this).val().trim();
                    const oscilloscope = document.oscilloscope;

                    if (offset === "") {
                        $(this).val(EngineeringValue.To(oscilloscope.offset[c - 1]));
                        return;
                    }

                    const offsetVoltage = EngineeringValue.From(offset.replace(/v$/i, ""));

                    if (isNaN(offsetVoltage))
                        mdui.snackbar({
                            message: `Invalid offset: ${offset}`,
                            position: "right-top"
                        });
                    else {
                        $(this).value(EngineeringValue.To(offsetVoltage));
                        oscilloscope.offset[c - 1] = offsetVoltage;
                        oscilloscope.redraw();
                    }
                })
            });
        </script>
    </div>
</div>

<script type="text/javascript">
    class Oscilloscope {
        _timeGridCount = 10;
        _voltageGridCount = 6;
        _timeGridSize = 0;
        _voltageGridSize = 0;

        _data = [[], []];

        started = false;
        // Data for channel 1 and 2
        amplitudePerGrid = [2, 2];
        offset = [0, 0];
        enabled = [true, true];
        timePerGrid = 1e-3;
        frequency = 1e6;
        samples = 2048;
        average = 1;
        triggerSource = 0;
        triggerVoltage = 0;


        constructor() {
            this._canvas = document.getElementById("oscilloscope-main");
            this._outerDiv = document.getElementById("oscilloscope-div");
            this._ctx = this._canvas.getContext("2d");

            setInterval(() => {
                this.resize();
            }, 100);
        }

        resize() {
            if (this._outerDiv === undefined)
                return;

            const width = this._outerDiv.clientWidth;

            if (width === this._canvas.width)
                return;

            this._canvas.width = width;
            this._canvas.height = width * 9 / 16;
            this._timeGridSize = this._canvas.width / this._timeGridCount;
            this._voltageGridSize = this._canvas.height / this._voltageGridCount;
            this.redraw();
        }

        redraw() {
            // Background
            this._ctx.fillStyle = "black";
            this._ctx.fillRect(0, 0, this._canvas.width, this._canvas.height);

            // Grid
            this._ctx.setLineDash([3, 7]);
            this._ctx.strokeStyle = "yellow";
            this._ctx.lineWidth = .5;
            for (let i = 1; i < this._timeGridCount; ++i) {
                this._ctx.beginPath();
                this._ctx.moveTo(Math.round(i * this._timeGridSize), 0);
                this._ctx.lineTo(Math.round(i * this._timeGridSize), this._canvas.height);
                this._ctx.stroke();
            }

            for (let i = 1; i < this._voltageGridCount; ++i) {
                this._ctx.beginPath();
                this._ctx.moveTo(0, Math.round(i * this._voltageGridSize));
                this._ctx.lineTo(this._canvas.width, Math.round(i * this._voltageGridSize));
                this._ctx.stroke();
            }

            // Line
            this._ctx.setLineDash([]);
            this._ctx.lineWidth = 1;
            for (const channel in [0, 1]) {
                this._ctx.strokeStyle = (channel === "1") ? "cyan" : "yellow";
                const deltaX = 1 / this.frequency / this.timePerGrid * this._timeGridSize;
                const stepY = this._voltageGridSize / this.amplitudePerGrid[channel];
                const offsetY = this.offset[channel] / this.amplitudePerGrid[channel] * this._voltageGridSize;
                for (let i = 0; i < this._data[channel].length - 1; ++i) {
                    const startX = this._canvas.width / 2 + (i - (this._data[channel].length - 1) / 2) * deltaX;
                    const stopX = this._canvas.width / 2 + (i + 1 - (this._data[channel].length - 1) / 2) * deltaX;
                    const startY = this._canvas.height / 2 - this._data[channel][i] * stepY - offsetY;
                    const stopY = this._canvas.height / 2 - this._data[channel][i + 1] * stepY - offsetY;
                    this._ctx.beginPath();
                    this._ctx.moveTo(startX, startY);
                    this._ctx.lineTo(stopX, stopY);
                    this._ctx.stroke();
                }
            }
        }

        sync() {
            $.ajax({
                method: "POST",
                url: "/Api/Oscilloscope",
                data: {
                    frequency: this.frequency,
                    samples: this.samples,
                },
                success: (data) => {
                    if (data.success === false)
                        mdui.snackbar({
                            message: `Failed to sync time: ${data.error}`,
                            position: "right-top"
                        })
                }
            });

            for (const channel in [0, 1]) {
                $.ajax({
                    method: "POST",
                    url: `/Api/Oscilloscope/Channel/${channel}`,
                    data: {
                        enabled: this.enabled[channel],
                        is25V: this.amplitudePerGrid[channel] * this._voltageGridCount / 2 >= 5,
                    },
                    success: (data) => {
                        if (data.success === false)
                            mdui.snackbar({
                                message: `Failed to sync channel ${channel}: ${data.error}`,
                                position: "right-top"
                            });
                    }
                });
            }
        }

        _update() {
            $.ajax({
                method: "GET",
                url: `/Api/Oscilloscope/Read`,
                success: (data) => {
                    if (data.success === false) {
                        // If stop() has been called, this query can fail
                        if (!this.started)
                            return;

                        mdui.snackbar({
                            message: `Failed to get data: ${data.error}`,
                            position: "right-top"
                        });

                        this.stop();
                    } else {
                        if (this.enabled[0])
                            this._data[0] = data.data.a;

                        if (this.enabled[1])
                            this._data[1] = data.data.b;

                        this.redraw();
                        (() => {
                            this._update();
                        })();
                    }
                }
            });
        }

        start() {
            if (this.started)
                return;

            $.ajax({
                method: "POST",
                url: "/Api/Oscilloscope/Start",
                success: (data) => {
                    if (data.success === false)
                        mdui.snackbar({
                            message: `Failed to start: ${data.error}`,
                            position: "right-top"
                        })
                    else {
                        this.started = true;
                        $("#start-button").text("停止");
                        (() => {
                            this._update();
                        })();
                    }
                }
            });
        }

        stop() {
            if (!this.started)
                return;

            $("#start-button").text("开始");

            $.ajax({
                method: "POST",
                url: "/Api/Oscilloscope/Stop",
                success: (data) => {
                    if (data.success === false)
                        mdui.snackbar({
                            message: `Failed to stop: ${data.error}`,
                            position: "right-top"
                        });
                }
            });

            this.started = false;
        }
    }

    document.oscilloscope = new Oscilloscope();
</script>

<script type="text/javascript" src="js/mdui.min.js"></script>
</body>
</html>
